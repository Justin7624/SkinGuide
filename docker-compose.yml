services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: skinguide
      POSTGRES_PASSWORD: skinguide
      POSTGRES_DB: skinguide
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports: ["6379:6379"]

  ml:
    build: ./services/ml
    environment:
      MODEL_VERSION: "0.1.0-mvp"
      TORCH_MODEL_PATH: "/models/current/model.pt"
    ports: ["8001:8001"]
    volumes:
      - modelshare:/models/current

  api:
    build: ./services/api
    environment:
      DATABASE_URL: "postgresql+psycopg://skinguide:skinguide@postgres:5432/skinguide"
      REDIS_URL: "redis://redis:6379/0"
      ML_URL: "http://ml:8001/infer"

      STORE_IMAGES_DEFAULT: "false"
      STORE_IMAGES_ENABLED: "true"
      DONATION_STORAGE_ENABLED: "true"

      STORAGE_BACKEND: "local"

      SESSION_SECRET: "dev-change-me"
      ADMIN_API_KEY: "dev-admin-change-me"

      MODEL_SHARED_DIR: "/models/current"
      MODEL_CURRENT_MANIFEST_PATH: "/models/current/manifest.json"
      MODEL_CURRENT_PT_PATH: "/models/current/model.pt"

      RATE_LIMIT_PER_MIN: "20"
      MAX_IMAGE_MB: "6"
    ports: ["8000:8000"]
    depends_on: [postgres, redis, ml]
    volumes:
      - apiimages:/data/images
      - apidonations:/data/donations
      - modelshare:/models/current

volumes:
  pgdata:
  apiimages:
  apidonations:
  modelshare:
